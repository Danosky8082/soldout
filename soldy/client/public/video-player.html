<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player - Soldout.com</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/styles/video.css">
</head>

<body>
    <div class="container">
        <header>
            <div class="logo" id="homeLink">
                <i class="fas fa-ticket-alt"></i>
                <span>Soldout.com</span>
            </div>
            <div class="nav-links">
                <a href="index.html" class="active home-link">Home</a>
                <a href="gallery.html">Movies</a>
                <a href="series.html">TV Shows</a>
                <a href="#">New Releases</a>
                <a href="soundtracks.html">Soundtracks</a>
            </div>
            <div class="user-actions">
                <i class="fas fa-search search-icon"></i>
                <i class="fas fa-bell"></i>
                <div class="user-info" id="userInfo"></div>
                <div class="user-icon-container" id="userDropdownTrigger">
                    <i class="fas fa-user-circle user-icon" id="userIcon"></i>
                    <div class="user-dropdown" id="userDropdown">
                        <a href="profile.html">Profile</a>
                        <a href="settings.html">Settings</a>
                        <a href="#" id="logoutBtn">Logout</a>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="video-container">
                <div class="video-player">
                    <!-- Star Rating Container -->
                    <div class="rating-container" id="ratingContainer">
                        <div class="rating-stars" id="ratingStars">
                            <input type="radio" id="star5" name="rating" value="5">
                            <label for="star5" title="5 stars"><i class="fas fa-star"></i></label>
                            <input type="radio" id="star4" name="rating" value="4">
                            <label for="star4" title="4 stars"><i class="fas fa-star"></i></label>
                            <input type="radio" id="star3" name="rating" value="3">
                            <label for="star3" title="3 stars"><i class="fas fa-star"></i></label>
                            <input type="radio" id="star2" name="rating" value="2">
                            <label for="star2" title="2 stars"><i class="fas fa-star"></i></label>
                            <input type="radio" id="star1" name="rating" value="1">
                            <label for="star1" title="1 star"><i class="fas fa-star"></i></label>
                        </div>
                        <div class="rating-average" id="ratingAverage">
                            <span class="average-value">0.0</span>
                            <span class="rating-count">(0 ratings)</span>
                        </div>
                    </div>
                    <button class="quality-toggle" id="qualityToggle">
                        <i class="fas fa-cog"></i> Quality
                    </button>
                    <div class="quality-selector" id="qualitySelector">
                        <div class="quality-option" data-quality="360">360p</div>
                        <div class="quality-option" data-quality="480">480p</div>
                        <div class="quality-option active" data-quality="720">720p</div>
                        <div class="quality-option" data-quality="1080">1080p</div>
                    </div>
                    <video id="mainPlayer" controls autoplay>
                        <source src="" type="video/mp4" data-quality="720">
                        Your browser does not support the video tag.
                    </video>
                </div>

                <div class="video-info">
                    <h1 id="playerTitle" class="video-title"></h1>
                    <div class="video-meta">
                        <div id="playerMeta" class="video-stats"></div>
                        <div class="video-actions">
                            <button class="action-button" id="likeButton">
                                <i class="fas fa-thumbs-up"></i>
                                <span id="likeCount">0</span>
                            </button>
                            <button class="action-button" id="dislikeButton">
                                <i class="fas fa-thumbs-down"></i>
                                <span id="dislikeCount">0</span>
                            </button>
                            <button class="action-button" id="shareButton">
                                <i class="fas fa-share"></i>
                                <span>Share</span>
                            </button>
                            <button class="action-button" id="saveButton">
                                <i class="fas fa-plus"></i>
                                <span>Save</span>
                            </button>
                        </div>
                    </div>
                    <div class="video-description">
                        <div id="playerDescription"></div>
                    </div>

                    <div class="uploader-info">
                        <div class="uploader-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="uploader-details">
                            <div class="uploader-name" id="uploaderName"></div>
                            <div class="subscribers-count" id="subscribersCount">1.2M subscribers</div>
                        </div>
                        <button class="subscribe-button" id="subscribeButton">SUBSCRIBE</button>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="comments-section">
                    <h3 class="comments-title">Comments <span id="commentsCount">(0)</span></h3>

                    <form class="comment-form" id="commentForm">
                        <input type="text" class="comment-input" id="commentInput" placeholder="Add a comment..."
                            required>
                        <button type="submit" class="comment-submit">Comment</button>
                    </form>

                    <div class="comment-list" id="commentList">
                        <!-- Comments will be added here dynamically -->
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="section-title">Similar Videos</div>
                <div class="related-videos" id="relatedVideos">
                    <!-- Related videos will be populated by JavaScript -->
                </div>

                <div class="trivia-container">
                    <div class="trivia-header">
                        <div class="trivia-title">Trivia</div>
                        <button class="trivia-add-btn" id="triviaAddBtn">
                            <i class="fas fa-plus"></i> Add Trivia
                        </button>
                    </div>
                    <div class="trivia-content" id="triviaContent">
                        <!-- Trivia items will be added here dynamically -->
                        <p class="no-trivia" id="noTrivia">No trivia added yet.</p>
                    </div>

                    <!-- Trivia Form (hidden by default) -->
                    <div class="trivia-form-container" id="triviaFormContainer" style="display: none;">
                        <textarea class="trivia-textarea" id="triviaTextarea"
                            placeholder="Enter trivia text..."></textarea>
                        <div class="trivia-actions">
                            <button class="trivia-save-btn" id="triviaSaveBtn">Save</button>
                            <button class="trivia-cancel-btn" id="triviaCancelBtn">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Share Modal -->
        <div class="share-modal" id="shareModal">
            <div class="share-modal-content">
                <div class="share-modal-header">
                    <h3>Share Video</h3>
                    <span class="share-modal-close" id="shareModalClose">&times;</span>
                </div>
                <div class="share-options">
                    <div class="share-option" id="shareFacebook">
                        <i class="fab fa-facebook"></i>
                        <span>Facebook</span>
                    </div>
                    <div class="share-option" id="shareTwitter">
                        <i class="fab fa-twitter"></i>
                        <span>Twitter</span>
                    </div>
                    <div class="share-option" id="shareWhatsApp">
                        <i class="fab fa-whatsapp"></i>
                        <span>WhatsApp</span>
                    </div>
                    <div class="share-option" id="shareLinkedIn">
                        <i class="fab fa-linkedin"></i>
                        <span>LinkedIn</span>
                    </div>
                </div>
                <div class="share-link-container">
                    <input type="text" class="share-link" id="shareLink" readonly>
                    <button class="copy-link" id="copyLinkBtn">Copy</button>
                </div>
            </div>
        </div>

        <footer>
            <div class="footer-links">
                <a href="#">About Us</a>
                <a href="#">Contact</a>
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
                <a href="#">Help Center</a>
            </div>
            <p class="copyright">&copy; 2025 Soldout.com. All rights reserved. The content on this site is protected by
                copyright.</p>
        </footer>

        <script>
            document.addEventListener('DOMContentLoaded', async () => {
                // API base URL
                const API_BASE_URL = 'http://localhost:5000';

                // Get logged in user from localStorage
                const loggedInUser = JSON.parse(localStorage.getItem('currentUser'));
                if (loggedInUser) {
                    document.getElementById('userInfo').textContent =
                        `${loggedInUser.firstName} ${loggedInUser.lastName}`;
                }

                // Get current video data from session storage
                const videoData = JSON.parse(sessionStorage.getItem('currentVideo'));

                if (!videoData) {
                    window.location.href = 'index.html';
                    return;
                }

                // Fetch video details from API
                let video;
                try {
                    const response = await fetch(`${API_BASE_URL}/api/videos/${videoData.id}${loggedInUser ? `?userId=${loggedInUser.id}` : ''}`);
                    if (!response.ok) throw new Error('Failed to fetch video');
                    video = await response.json();

                    // Initialize default values if they don't exist
                    if (!video._count) video._count = { likes: 0, subscribers: 0 };
                    if (!video.comments) video.comments = [];

                } catch (error) {
                    console.error('Error loading video:', error);
                    window.location.href = 'index.html';
                    return;
                }

                // Set current video data
                const videoPlayer = document.getElementById('mainPlayer');
                videoPlayer.src = video.videoUrl;
                document.getElementById('playerTitle').textContent = video.title;
                document.getElementById('uploaderName').textContent = video.user?.firstName + ' ' + video.user?.lastName || 'Unknown';

                const metaHtml = `
                    <span>${video.views?.toLocaleString() || '0'} views</span> • 
                    <span>${new Date(video.createdAt).toLocaleDateString()}</span>
                `;
                document.getElementById('playerMeta').innerHTML = metaHtml;

                if (video.description) {
                    document.getElementById('playerDescription').textContent = video.description;
                }

                // Update UI elements
                updateVideoUI(video);

                // Initialize star rating
                initStarRating(video);

                // Like button functionality
                document.getElementById('likeButton').addEventListener('click', async () => {
                    if (!loggedInUser) {
                        alert('Please log in to like videos');
                        return;
                    }
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/interactions/like`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                type: 'VIDEO',
                                userId: loggedInUser.id,
                                videoId: video.id
                            })
                        });

                        if (response.ok) {
                            // Refresh video data
                            const videoResponse = await fetch(`${API_BASE_URL}/api/videos/${video.id}${loggedInUser ? `?userId=${loggedInUser.id}` : ''}`);
                            video = await videoResponse.json();
                            updateVideoUI(video);
                        }
                    } catch (error) {
                        console.error('Error toggling like:', error);
                    }
                });

                // Dislike button functionality
                document.getElementById('dislikeButton').addEventListener('click', async () => {
                    if (!loggedInUser) {
                        alert('Please log in to dislike videos');
                        return;
                    }
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/interactions/like`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                type: 'VIDEO',
                                userId: loggedInUser.id,
                                videoId: video.id,
                                isDislike: true
                            })
                        });

                        if (response.ok) {
                            // Refresh video data
                            const videoResponse = await fetch(`${API_BASE_URL}/api/videos/${video.id}${loggedInUser ? `?userId=${loggedInUser.id}` : ''}`);
                            video = await videoResponse.json();
                            updateVideoUI(video);
                        }
                    } catch (error) {
                        console.error('Error toggling dislike:', error);
                    }
                });

                // Subscribe button functionality - now tied to channel/user
                document.getElementById('subscribeButton').addEventListener('click', async () => {
                    if (!loggedInUser) {
                        alert('Please log in to subscribe to channels');
                        return;
                    }

                    if (!video.user?.id) {
                        alert('This channel cannot be subscribed to');
                        return;
                    }

                    const subscribeButton = document.getElementById('subscribeButton');
                    const isCurrentlySubscribed = subscribeButton.classList.contains('subscribed');
                    const channelId = video.user.id;

                    try {
                        // Show loading state
                        subscribeButton.disabled = true;
                        subscribeButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                        // First update the subscriber count
                        const countResponse = await fetch(`${API_BASE_URL}/api/users/${channelId}/subscribers`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            },
                            body: JSON.stringify({
                                increment: !isCurrentlySubscribed
                            })
                        });

                        if (!countResponse.ok) {
                            throw new Error('Failed to update subscriber count');
                        }

                        // Then handle the subscription/unsubscription
                        const subscriptionResponse = await fetch(`${API_BASE_URL}/api/subscriptions`, {
                            method: isCurrentlySubscribed ? 'DELETE' : 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            },
                            body: JSON.stringify({
                                subscriberId: loggedInUser.id,
                                channelId: channelId
                            })
                        });

                        if (!subscriptionResponse.ok) {
                            throw new Error(`HTTP error! status: ${subscriptionResponse.status}`);
                        }

                        // Toggle UI state
                        if (isCurrentlySubscribed) {
                            subscribeButton.classList.remove('subscribed');
                            subscribeButton.textContent = 'SUBSCRIBE';
                        } else {
                            subscribeButton.classList.add('subscribed');
                            subscribeButton.textContent = 'SUBSCRIBED';
                        }

                        // Update subscriber count display
                        const subCountElement = document.getElementById('subscribersCount');
                        const currentCount = parseInt(subCountElement.textContent.replace(/\D/g, '')) || 0;
                        subCountElement.textContent =
                            (isCurrentlySubscribed ? Math.max(0, currentCount - 1) : currentCount + 1) +
                            ' subscriber' + (currentCount !== 1 ? 's' : '');

                    } catch (error) {
                        console.error('Subscription error:', error);

                        // More specific error messages
                        if (error.message.includes('401')) {
                            alert('Session expired. Please log in again.');
                            localStorage.removeItem('authToken');
                            localStorage.removeItem('currentUser');
                            window.location.href = 'login.html';
                        } else if (error.message.includes('Failed to update subscriber count')) {
                            alert('Could not update subscriber count. The subscription was not changed.');
                        } else {
                            alert('Failed to update subscription. Please try again.');
                        }
                    } finally {
                        subscribeButton.disabled = false;
                    }
                });

                // Improved subscription status check
                async function checkSubscriptionStatus() {
                    if (!loggedInUser || !video.user?.id) {
                        return;
                    }

                    const subscribeButton = document.getElementById('subscribeButton');

                    try {
                        const response = await fetch(`${API_BASE_URL}/api/subscriptions/check?subscriberId=${loggedInUser.id}&channelId=${video.user.id}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            }
                        });

                        if (response.ok) {
                            const { isSubscribed } = await response.json();

                            subscribeButton.classList.toggle('subscribed', isSubscribed);
                            subscribeButton.textContent = isSubscribed ? 'SUBSCRIBED' : 'SUBSCRIBE';
                        } else if (response.status === 404) {
                            // Subscription doesn't exist (not an error)
                            subscribeButton.classList.remove('subscribed');
                            subscribeButton.textContent = 'SUBSCRIBE';
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (error) {
                        console.error('Subscription check error:', error);
                        // Don't show error to user for status check
                    }
                }

                // Call this to initialize subscription status when page loads
                checkSubscriptionStatus();

                // Update video UI function
                function updateVideoUI(video) {
                    // Update like count
                    document.getElementById('likeCount').textContent = video.likeCount || 0;

                    // Update dislike count
                    document.getElementById('dislikeCount').textContent = video.dislikeCount || 0;

                    // Update subscription status
                    const subscribeButton = document.getElementById('subscribeButton');
                    if (video.isSubscribed) {
                        subscribeButton.classList.add('subscribed');
                        subscribeButton.textContent = 'SUBSCRIBED';
                    } else {
                        subscribeButton.classList.remove('subscribed');
                        subscribeButton.textContent = 'SUBSCRIBE';
                    }

                    // Update subscriber count with proper formatting
                    const subCount = video.user?.subscriberCount || 0;
                    let displayCount;
                    if (subCount >= 1000000) {
                        displayCount = (subCount / 1000000).toFixed(1) + 'M';
                    } else if (subCount >= 1000) {
                        displayCount = (subCount / 1000).toFixed(1) + 'K';
                    } else {
                        displayCount = subCount;
                    }
                    document.getElementById('subscribersCount').textContent = displayCount + ' subscribers';
                }

                function initStarRating(video) {
                    const ratingStars = document.getElementById('ratingStars');
                    const averageValue = document.querySelector('.average-value');
                    const ratingCount = document.querySelector('.rating-count');

                    // Set initial rating
                    if (video.averageRating) {
                        averageValue.textContent = video.averageRating;
                        ratingCount.textContent = `(${video._count?.ratings || 0} ratings)`;

                        // Check if user has rated
                        if (video.userRating) {
                            const starId = `star${video.userRating}`;
                            document.getElementById(starId).checked = true;
                        }
                    }

                    // Add event listeners for rating stars
                    ratingStars.addEventListener('change', async (e) => {
                        if (!loggedInUser) {
                            alert('Please log in to rate videos');
                            return;
                        }

                        const ratingValue = e.target.value;
                        try {
                            const response = await fetch(`${API_BASE_URL}/api/interactions/rate`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    userId: loggedInUser.id,
                                    videoId: video.id,
                                    value: ratingValue
                                })
                            });

                            if (response.ok) {
                                const result = await response.json();
                                averageValue.textContent = result.average;
                                ratingCount.textContent = `(${result.count} ratings)`;
                            }
                        } catch (error) {
                            console.error('Error submitting rating:', error);
                        }
                    });
                }

                // Comment functionality with enhanced nested reply system
                const commentForm = document.getElementById('commentForm');
                const commentInput = document.getElementById('commentInput');
                const commentList = document.getElementById('commentList');

                // Helper function to format dates
                function formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }

                // Helper function to create comment element
                function createCommentElement(commentData, isReply = false, depth = 0) {
                    const commentElement = document.createElement('div');
                    commentElement.className = isReply ? 'comment reply' : 'comment';
                    commentElement.dataset.id = commentData.id;
                    commentElement.style.marginLeft = `${depth * 20}px`;

                    const isLiked = commentData.likes?.some(like => like.userId === loggedInUser?.id);
                    const likeCount = commentData._count?.likes || 0;

                    commentElement.innerHTML = `
                        <div class="comment-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="comment-content">
                            <div class="comment-author">${commentData.user?.firstName || 'User'} ${commentData.user?.lastName || ''}</div>
                            <div class="comment-text">${commentData.text}</div>
                            <div class="comment-actions">
                                <span class="comment-action like-comment ${isLiked ? 'liked' : ''}" data-id="${commentData.id}" data-type="${isReply ? 'REPLY' : 'COMMENT'}">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span class="like-count">${likeCount}</span>
                                </span>
                                <span class="comment-action reply-comment">
                                    <i class="fas fa-reply"></i>
                                    <span>Reply</span>
                                </span>
                                <span class="comment-timestamp">${formatDate(commentData.createdAt)}</span>
                            </div>
                            <div class="replies-container" id="replies-container-${commentData.id}">
                                <div class="replies" id="replies-${commentData.id}"></div>
                                <div class="reply-form-container" id="reply-form-${commentData.id}"></div>
                            </div>
                        </div>
                    `;

                    return commentElement;
                }

                // Helper function to create reply form
                function createReplyForm(parentId, depth) {
                    const form = document.createElement('form');
                    form.className = 'reply-form';
                    form.innerHTML = `
                        <input type="text" class="reply-input" placeholder="Write a reply..." required>
                        <button type="submit" class="reply-submit">Reply</button>
                        <button type="button" class="cancel-reply">Cancel</button>
                    `;
                    form.style.marginLeft = `${(depth + 1) * 20}px`;
                    return form;
                }

                // Recursive function to render comments and their replies
                function renderComments(comments, parentElement = null, isReply = false, depth = 0) {
                    const container = parentElement || document.getElementById('commentList');

                    if (!parentElement && comments.length === 0) {
                        container.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
                        document.getElementById('commentsCount').textContent = '(0)';
                        return;
                    }

                    if (!parentElement) {
                        container.innerHTML = '';
                        document.getElementById('commentsCount').textContent = `(${comments.length})`;
                    }

                    // Sort comments by date (newest first)
                    comments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    comments.forEach(comment => {
                        const commentElement = createCommentElement(comment, isReply, depth);
                        container.appendChild(commentElement);

                        // Render replies if any
                        if (comment.replies && comment.replies.length > 0) {
                            const repliesContainer = document.getElementById(`replies-${comment.id}`);
                            if (repliesContainer) {
                                renderComments(comment.replies, repliesContainer, true, depth + 1);
                            }
                        }

                        // Like functionality
                        const likeButton = commentElement.querySelector('.like-comment');
                        likeButton.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            if (!loggedInUser) {
                                alert('Please log in to like');
                                return;
                            }

                            const commentId = likeButton.dataset.id;
                            const type = likeButton.dataset.type;

                            try {
                                const response = await fetch(`${API_BASE_URL}/api/interactions/like`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        type,
                                        userId: loggedInUser.id,
                                        [type === 'COMMENT' ? 'commentId' : 'replyId']: commentId
                                    })
                                });

                                if (response.ok) {
                                    const videoResponse = await fetch(`${API_BASE_URL}/api/videos/${video.id}${loggedInUser ? `?userId=${loggedInUser.id}` : ''}`);
                                    video = await videoResponse.json();
                                    renderComments(video.comments || []);
                                }
                            } catch (error) {
                                console.error('Error toggling like:', error);
                            }
                        });

                        // Reply functionality
                        const replyButton = commentElement.querySelector('.reply-comment');
                        replyButton.addEventListener('click', () => {
                            if (!loggedInUser) {
                                alert('Please log in to reply');
                                return;
                            }

                            const replyFormContainer = document.getElementById(`reply-form-${comment.id}`);
                            const existingForm = replyFormContainer.querySelector('.reply-form');

                            if (existingForm) {
                                existingForm.querySelector('.reply-input').focus();
                                return;
                            }

                            replyFormContainer.innerHTML = '';
                            const replyForm = createReplyForm(comment.id, depth);

                            // In your existing code, replace the reply form submit handler with this improved version:

                            replyForm.addEventListener('submit', async (e) => {
                                e.preventDefault();
                                const replyInput = replyForm.querySelector('.reply-input');
                                const replyText = replyInput.value.trim();

                                if (!replyText) {
                                    alert('Please enter a reply');
                                    return;
                                }

                                const submitBtn = replyForm.querySelector('.reply-submit');
                                try {
                                    submitBtn.disabled = true;
                                    submitBtn.textContent = 'Posting...';

                                    // 1. Prepare the payload
                                    const payload = {
                                        text: replyText,
                                        userId: loggedInUser.id,
                                        videoId: video.id,
                                        commentId: comment.id
                                    };

                                    // Only add parentReplyId if this is a nested reply
                                    if (comment.isReply) {
                                        payload.parentReplyId = comment.id;
                                    }

                                    // 2. Debug output
                                    console.group('Reply Submission Debug');
                                    console.log('Endpoint:', `${API_BASE_URL}/api/interactions/reply`);
                                    console.log('Headers:', {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                                    });
                                    console.log('Payload:', payload);
                                    console.groupEnd();

                                    // 3. Make the request
                                    const response = await fetch(`${API_BASE_URL}/api/interactions/reply`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                                        },
                                        body: JSON.stringify(payload)
                                    });

                                    // 4. Handle the response
                                    const contentType = response.headers.get('content-type');
                                    let responseData;

                                    if (contentType && contentType.includes('application/json')) {
                                        responseData = await response.json();
                                    } else {
                                        responseData = await response.text();
                                    }

                                    console.log('Response:', {
                                        status: response.status,
                                        data: responseData
                                    });

                                    if (!response.ok) {
                                        // Handle different error statuses
                                        if (response.status === 401) {
                                            throw new Error('Session expired. Please log in again.');
                                        } else if (response.status === 404) {
                                            throw new Error('Comment not found');
                                        } else {
                                            throw new Error(responseData.message || 'Failed to post reply');
                                        }
                                    }

                                    // 5. Success case
                                    const newReply = responseData;

                                    if (!newReply.user) {
                                        newReply.user = {
                                            firstName: loggedInUser.firstName,
                                            lastName: loggedInUser.lastName
                                        };
                                    }

                                    // Update UI
                                    const repliesContainer = document.getElementById(`replies-${comment.id}`) ||
                                        document.createElement('div');
                                    repliesContainer.id = `replies-${comment.id}`;
                                    repliesContainer.className = 'replies';

                                    if (!document.getElementById(`replies-${comment.id}`)) {
                                        const repliesContainerWrapper = document.getElementById(`replies-container-${comment.id}`);
                                        repliesContainerWrapper.insertBefore(repliesContainer, replyFormContainer);
                                    }

                                    const replyElement = createCommentElement(newReply, true, depth + 1);
                                    repliesContainer.appendChild(replyElement);

                                    // Set up handlers for the new reply
                                    setupReplyHandlers(replyElement, newReply, depth + 1);

                                    // Clear form
                                    replyInput.value = '';
                                    replyFormContainer.innerHTML = '';

                                } catch (error) {
                                    console.error('Error details:', {
                                        name: error.name,
                                        message: error.message,
                                        stack: error.stack
                                    });

                                    // Show user-friendly error message
                                    let errorMessage = error.message;

                                    if (error.message.includes('Failed to fetch')) {
                                        errorMessage = 'Network error. Please check your connection.';
                                    } else if (error.message.includes('401')) {
                                        errorMessage = 'Session expired. Redirecting to login...';
                                        localStorage.removeItem('authToken');
                                        localStorage.removeItem('currentUser');
                                        setTimeout(() => window.location.href = 'login.html', 2000);
                                    }

                                    alert(`Error: ${errorMessage}`);
                                } finally {
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = 'Reply';
                                }
                            });
                            const cancelButton = replyForm.querySelector('.cancel-reply');
                            cancelButton.addEventListener('click', () => {
                                replyFormContainer.innerHTML = '';
                            });

                            replyFormContainer.appendChild(replyForm);
                            replyForm.querySelector('.reply-input').focus();
                        });
                    });
                }

                // Function to setup reply handlers for a comment element
                function setupReplyHandlers(commentElement, commentData, depth) {
                    // Like functionality
                    const likeButton = commentElement.querySelector('.like-comment');
                    likeButton.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (!loggedInUser) {
                            alert('Please log in to like');
                            return;
                        }

                        const commentId = likeButton.dataset.id;
                        const type = likeButton.dataset.type;

                        try {
                            const response = await fetch(`${API_BASE_URL}/api/interactions/like`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    type,
                                    userId: loggedInUser.id,
                                    [type === 'COMMENT' ? 'commentId' : 'replyId']: commentId
                                })
                            });

                            if (response.ok) {
                                const videoResponse = await fetch(`${API_BASE_URL}/api/videos/${video.id}${loggedInUser ? `?userId=${loggedInUser.id}` : ''}`);
                                video = await videoResponse.json();
                                renderComments(video.comments || []);
                            }
                        } catch (error) {
                            console.error('Error toggling like:', error);
                        }
                    });

                    // Reply functionality
                    const replyButton = commentElement.querySelector('.reply-comment');
                    replyButton.addEventListener('click', () => {
                        if (!loggedInUser) {
                            alert('Please log in to reply');
                            return;
                        }

                        const replyFormContainer = document.getElementById(`reply-form-${commentData.id}`);
                        const existingForm = replyFormContainer.querySelector('.reply-form');

                        if (existingForm) {
                            existingForm.querySelector('.reply-input').focus();
                            return;
                        }

                        replyFormContainer.innerHTML = '';
                        const replyForm = createReplyForm(commentData.id, depth);

                        // Replace your reply form submit handler with this enhanced version:
                        replyForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const replyInput = replyForm.querySelector('.reply-input');
                            const replyText = replyInput.value.trim();

                            if (!replyText) {
                                alert('Please enter a reply');
                                return;
                            }

                            const submitBtn = replyForm.querySelector('.reply-submit');
                            try {
                                submitBtn.disabled = true;
                                submitBtn.textContent = 'Posting...';

                                // Debug: Log the current comment data
                                console.log('Replying to comment:', {
                                    commentId: comment.id,
                                    isReply: comment.isReply,
                                    depth: depth
                                });

                                // Prepare the request payload
                                const payload = {
                                    text: replyText,
                                    userId: loggedInUser.id,
                                    videoId: video.id,
                                    commentId: comment.id // Always include the original comment ID
                                };

                                // Only include parentReplyId if this is a reply to another reply
                                if (comment.isReply) {
                                    payload.parentReplyId = comment.id;
                                }

                                console.log('Sending payload:', payload);

                                const response = await fetch(`${API_BASE_URL}/api/interactions/reply`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                                    },
                                    body: JSON.stringify(payload)
                                });

                                console.log('Response status:', response.status);

                                if (!response.ok) {
                                    // Try to get error details from response
                                    let errorMsg = 'Failed to post reply';
                                    try {
                                        const errorData = await response.json();
                                        errorMsg = errorData.message || errorMsg;
                                        console.error('API Error Details:', errorData);
                                    } catch (parseError) {
                                        console.error('Failed to parse error response:', parseError);
                                    }
                                    throw new Error(errorMsg);
                                }

                                const newReply = await response.json();
                                console.log('Reply created successfully:', newReply);

                                // Ensure user data exists for the reply
                                if (!newReply.user && loggedInUser) {
                                    newReply.user = {
                                        firstName: loggedInUser.firstName,
                                        lastName: loggedInUser.lastName
                                    };
                                }

                                // Update UI
                                const repliesContainer = document.getElementById(`replies-${comment.id}`) ||
                                    createRepliesContainer(comment.id);

                                const replyElement = createCommentElement(newReply, true, depth + 1);
                                repliesContainer.appendChild(replyElement);

                                // Set up handlers for the new reply
                                setupReplyHandlers(replyElement, newReply, depth + 1);

                                // Clear form
                                replyInput.value = '';
                                replyFormContainer.innerHTML = '';

                            } catch (error) {
                                console.error('Full error details:', {
                                    error: error,
                                    message: error.message,
                                    stack: error.stack
                                });

                                alert(`Error posting reply: ${error.message}\nCheck console for details.`);

                                // Handle unauthorized errors
                                if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                                    localStorage.removeItem('authToken');
                                    localStorage.removeItem('currentUser');
                                    window.location.href = 'login.html';
                                }
                            } finally {
                                submitBtn.disabled = false;
                                submitBtn.textContent = 'Reply';
                            }
                        });
                        const cancelButton = replyForm.querySelector('.cancel-reply');
                        cancelButton.addEventListener('click', () => {
                            replyFormContainer.innerHTML = '';
                        });

                        replyFormContainer.appendChild(replyForm);
                        replyForm.querySelector('.reply-input').focus();
                    });
                }

                // Load existing comments
                renderComments(video.comments || []);

                commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    if (!loggedInUser) {
                        alert('Please log in to comment');
                        return;
                    }

                    const commentText = commentInput.value.trim();
                    if (commentText) {
                        try {
                            const response = await fetch(`${API_BASE_URL}/api/interactions/comment`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                                },
                                body: JSON.stringify({
                                    text: commentText,
                                    userId: loggedInUser.id,
                                    videoId: video.id
                                })
                            });

                            if (!response.ok) {
                                const error = await response.json();
                                throw new Error(error.message || 'Failed to post comment');
                            }

                            const videoResponse = await fetch(`${API_BASE_URL}/api/videos/${video.id}${loggedInUser ? `?userId=${loggedInUser.id}` : ''}`);
                            video = await videoResponse.json();
                            renderComments(video.comments || []);
                            commentInput.value = '';
                            document.getElementById('commentsCount').textContent = `(${video.comments.length})`;

                        } catch (error) {
                            console.error('Error posting comment:', error);
                            alert(error.message || 'Failed to post comment');

                            // Clear auth data if unauthorized
                            if (error.message.includes('401')) {
                                localStorage.removeItem('authToken');
                                localStorage.removeItem('currentUser');
                            }
                        }
                    }
                });

                // Load related videos
                const relatedVideosContainer = document.getElementById('relatedVideos');
                relatedVideosContainer.innerHTML = '<p class="loading">Loading similar videos...</p>';

                try {
                    const response = await fetch(`${API_BASE_URL}/api/videos/premium`);
                    if (!response.ok) throw new Error('Failed to fetch videos');

                    let allVideos = await response.json();

                    // Filter related videos
                    const relatedVideos = allVideos.filter(v =>
                        v.genre === video.genre && v.id !== video.id
                    ).slice(0, 6);

                    // Display related videos
                    relatedVideosContainer.innerHTML = '';
                    if (relatedVideos.length === 0) {
                        relatedVideosContainer.innerHTML = '<p>No similar videos found</p>';
                        return;
                    }

                    relatedVideos.forEach(video => {
                        const videoElement = document.createElement('div');
                        videoElement.className = 'related-video';
                        videoElement.innerHTML = `
                            <div class="related-thumbnail">
                                <img src="${video.thumbnail}" alt="${video.title}">
                                ${video.duration ? `<span class="related-duration">${video.duration}</span>` : ''}
                            </div>
                            <div class="related-info">
                                <div class="related-title">${video.title}</div>
                                <div class="related-uploader">${video.user?.firstName} ${video.user?.lastName || 'Unknown'}</div>
                                <div class="related-stats">
                                    ${video.views ? video.views.toLocaleString() + ' views' : ''} 
                                    ${video.year ? '• ' + video.year : ''}
                                </div>
                            </div>
                        `;

                        videoElement.addEventListener('click', () => {
                            sessionStorage.setItem('currentVideo', JSON.stringify({
                                id: video.id,
                                title: video.title,
                                description: video.description,
                                genre: video.genre,
                                year: video.year,
                                thumbnail: video.thumbnail,
                                videoUrl: video.videoUrl,
                                uploaderName: `${video.user?.firstName} ${video.user?.lastName}`
                            }));
                            window.location.reload();
                        });

                        relatedVideosContainer.appendChild(videoElement);
                    });

                } catch (error) {
                    console.error('Error loading videos:', error);
                    relatedVideosContainer.innerHTML = `
                        <p class="error-message">
                            Error loading similar videos. 
                            <button onclick="location.reload()">Try Again</button>
                        </p>
                    `;
                }

                // Share button functionality
                const shareButton = document.getElementById('shareButton');
                const shareModal = document.getElementById('shareModal');
                const shareModalClose = document.getElementById('shareModalClose');
                const copyLinkBtn = document.getElementById('copyLinkBtn');
                const shareLink = document.getElementById('shareLink');

                shareButton.addEventListener('click', () => {
                    shareLink.value = window.location.href;
                    shareModal.style.display = 'flex';
                });

                shareModalClose.addEventListener('click', () => {
                    shareModal.style.display = 'none';
                });

                copyLinkBtn.addEventListener('click', () => {
                    shareLink.select();
                    document.execCommand('copy');
                    copyLinkBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyLinkBtn.textContent = 'Copy';
                    }, 2000);
                });

                window.addEventListener('click', (e) => {
                    if (e.target === shareModal) {
                        shareModal.style.display = 'none';
                    }
                });

                // Social share buttons
                document.getElementById('shareFacebook').addEventListener('click', () => {
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank');
                });

                document.getElementById('shareTwitter').addEventListener('click', () => {
                    window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(window.location.href)}`, '_blank');
                });

                document.getElementById('shareWhatsApp').addEventListener('click', () => {
                    window.open(`https://wa.me/?text=${encodeURIComponent(window.location.href)}`, '_blank');
                });

                document.getElementById('shareLinkedIn').addEventListener('click', () => {
                    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}`, '_blank');
                });

                // Save button functionality
                const saveButton = document.getElementById('saveButton');
                saveButton.addEventListener('click', async () => {
                    if (!loggedInUser) {
                        alert('Please log in to save videos');
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/api/interactions/save`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                userId: loggedInUser.id,
                                videoId: video.id
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.action === 'saved') {
                                saveButton.innerHTML = '<i class="fas fa-check"></i> <span>Saved</span>';
                                saveButton.classList.add('saved');
                            } else {
                                saveButton.innerHTML = '<i class="fas fa-plus"></i> <span>Save</span>';
                                saveButton.classList.remove('saved');
                            }
                        }
                    } catch (error) {
                        console.error('Error saving video:', error);
                    }
                });

                // Check if video is already saved
                if (loggedInUser) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/interactions/saved/${loggedInUser.id}/${video.id}`);
                        if (response.ok) {
                            const isSaved = await response.json();
                            if (isSaved) {
                                saveButton.innerHTML = '<i class="fas fa-check"></i> <span>Saved</span>';
                                saveButton.classList.add('saved');
                            }
                        }
                    } catch (error) {
                        console.error('Error checking saved status:', error);
                    }
                }

                // Trivia functionality
                const triviaAddBtn = document.getElementById('triviaAddBtn');
                const triviaFormContainer = document.getElementById('triviaFormContainer');
                const triviaSaveBtn = document.getElementById('triviaSaveBtn');
                const triviaCancelBtn = document.getElementById('triviaCancelBtn');
                const triviaTextarea = document.getElementById('triviaTextarea');
                const triviaContent = document.getElementById('triviaContent');
                const noTrivia = document.getElementById('noTrivia');

                // Load existing trivia
                async function loadTrivia() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/videos/${video.id}/trivia`);
                        if (!response.ok) throw new Error('Failed to fetch trivia');
                        const trivia = await response.json();

                        triviaContent.innerHTML = '';
                        if (trivia.length === 0) {
                            triviaContent.appendChild(noTrivia);
                            return;
                        }

                        trivia.forEach(item => {
                            const triviaItem = document.createElement('div');
                            triviaItem.className = 'trivia-item';
                            triviaItem.dataset.id = item.id;
                            triviaItem.innerHTML = `
                                <p class="trivia-text">${item.text}</p>
                                <div class="trivia-meta">
                                    <span>Added by ${item.user.firstName} ${item.user.lastName}</span>
                                    ${item.user.id === loggedInUser?.id ? `
                                    <div class="trivia-actions">
                                        <button class="trivia-edit"><i class="fas fa-edit"></i></button>
                                        <button class="trivia-delete"><i class="fas fa-trash"></i></button>
                                    </div>
                                    ` : ''}
                                </div>
                            `;

                            triviaContent.appendChild(triviaItem);

                            // Add edit and delete functionality if user is owner
                            if (item.user.id === loggedInUser?.id) {
                                const editBtn = triviaItem.querySelector('.trivia-edit');
                                const deleteBtn = triviaItem.querySelector('.trivia-delete');

                                editBtn.addEventListener('click', () => {
                                    triviaTextarea.value = item.text;
                                    triviaFormContainer.style.display = 'block';
                                    triviaItem.remove();
                                });

                                deleteBtn.addEventListener('click', async () => {
                                    if (confirm('Are you sure you want to delete this trivia?')) {
                                        try {
                                            const response = await fetch(`${API_BASE_URL}/api/interactions/trivia/${item.id}`, {
                                                method: 'DELETE'
                                            });

                                            if (response.ok) {
                                                triviaItem.remove();
                                                if (triviaContent.children.length === 0) {
                                                    triviaContent.appendChild(noTrivia);
                                                }
                                            }
                                        } catch (error) {
                                            console.error('Error deleting trivia:', error);
                                            alert('Failed to delete trivia');
                                        }
                                    }
                                });
                            }
                        });
                    } catch (error) {
                        console.error('Error loading trivia:', error);
                    }
                }

                // Initial load
                loadTrivia();

                triviaAddBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (!loggedInUser) {
                        alert('Please log in to add trivia');
                        return;
                    }
                    triviaFormContainer.style.display = 'block';
                });

                triviaCancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    triviaFormContainer.style.display = 'none';
                    triviaTextarea.value = '';
                });

                triviaSaveBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const triviaText = triviaTextarea.value.trim();

                    if (!triviaText) {
                        alert('Please enter trivia text');
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/api/interactions/trivia`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: triviaText,
                                userId: loggedInUser.id,
                                videoId: video.id
                            })
                        });

                        if (response.ok) {
                            const newTrivia = await response.json();
                            triviaFormContainer.style.display = 'none';
                            triviaTextarea.value = '';
                            loadTrivia();
                        } else {
                            throw new Error('Failed to save trivia');
                        }
                    } catch (error) {
                        console.error('Error saving trivia:', error);
                        alert('Failed to save trivia');
                    }
                });

                // Quality selector functionality
                const qualityToggle = document.getElementById('qualityToggle');
                const qualitySelector = document.getElementById('qualitySelector');
                const qualityOptions = document.querySelectorAll('.quality-option');

                qualityToggle.addEventListener('click', () => {
                    qualitySelector.style.display = qualitySelector.style.display === 'block' ? 'none' : 'block';
                });

                qualityOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const quality = option.dataset.quality;
                        const videoSources = document.querySelectorAll('#mainPlayer source');

                        // Update active state
                        qualityOptions.forEach(opt => opt.classList.remove('active'));
                        option.classList.add('active');

                        // Change video source
                        videoSources.forEach(source => {
                            if (source.dataset.quality === quality) {
                                videoPlayer.src = source.src;
                                videoPlayer.load();
                            }
                        });

                        qualitySelector.style.display = 'none';
                    });
                });
            });

            // Logout functionality
            document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('currentUser');
                localStorage.removeItem('authToken');
                window.location.href = 'index.html';
            });
        </script>
</body>

</html>